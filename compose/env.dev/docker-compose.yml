version: '2.1'

services:
  rabbit:
    image: rabbit:latest
    env_file: ~/work/docker.data/rabbit.env
    expose: 
      - "5672"
    healthcheck:
      test: ["CMD", "check-running.sh"]
      interval: 5s
      timeout: 3s
  srmail:
    image: srmail:latest
    volumes:
      - ~/work/docker.data/srmail.config.json:/app/config.json
      - ~/work/docker.data/srmail.db.sqlite:/app/srmail/db.sqlite
    depends_on:
      rabbit:
        condition: service_healthy
  mail2run:
    image: mail2run:latest
    volumes:
      - ~/work/docker.data/mail2run.config.json:/app/config.json
    depends_on:
      - srmail
  mail2diaspora:
    image: mail2diaspora:latest
    volumes:
      - ~/work/docker.data/mail2diaspora.config.json:/app/config.json
    depends_on:
      - srmail  
  stacosys:
    image: stacosys:latest
    volumes:
      - ~/work/docker.data/stacosys.config.json:/app/config.json
      - ~/work/docker.data/stacosys.db.sqlite:/app/stacosys/db.sqlite
    expose:
      - "8100"
    depends_on:
      rabbit:
        condition: service_healthy
      srmail:
        condition: service_started   
  hugo-serve:
    image: hugo-serve:latest
    ports:
      - "80:80"
    volumes:
      - ~/work/blog:/site
    depends_on:
      - stacosys